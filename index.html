<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZEM-017 Colorful Dashboard</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    
    <link href="https://fonts.cdnfonts.com/css/digital-7-mono" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Definisi Warna Palette */
            --color-bg-1: #1a1a2e;
            --color-bg-2: #16213e;
            --color-volt: #00d2ff;   /* Biru Cerah */
            --color-amp: #ff2e63;    /* Pink Merah */
            --color-watt: #08d9d6;   /* Teal/Hijau Neon */
            --color-kwh: #f9ed69;    /* Kuning Emas */
            --card-bg: rgba(255, 255, 255, 0.05);
        }

        body {
            /* Latar Belakang Gradasi Animasi */
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #1a1a2e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(to right, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-align: center;
        }

        #status {
            font-size: 0.9rem;
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
            margin-bottom: 40px;
            font-weight: bold;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .status-connected { color: #00ff88 !important; border: 1px solid #00ff88; box-shadow: 0 0 10px rgba(0, 255, 136, 0.2); }
        .status-disconnected { color: #ff4d4d !important; border: 1px solid #ff4d4d; }

        /* Container Grid */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1100px;
        }

        /* Card Style - Glassmorphism */
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            transition: transform 0.3s, box-shadow 0.3s;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        /* Styling Spesifik per Kartu (Warna Warni) */
        
        /* 1. Voltage (Biru) */
        .card-volt { border-bottom: 4px solid var(--color-volt); }
        .card-volt:hover { box-shadow: 0 10px 40px rgba(0, 210, 255, 0.2); }
        .card-volt .icon-bg { background: var(--color-volt); }
        .card-volt .value { color: var(--color-volt); text-shadow: 0 0 15px rgba(0, 210, 255, 0.4); }

        /* 2. Current (Merah/Pink) */
        .card-amp { border-bottom: 4px solid var(--color-amp); }
        .card-amp:hover { box-shadow: 0 10px 40px rgba(255, 46, 99, 0.2); }
        .card-amp .icon-bg { background: var(--color-amp); }
        .card-amp .value { color: var(--color-amp); text-shadow: 0 0 15px rgba(255, 46, 99, 0.4); }

        /* 3. Power (Teal/Hijau) */
        .card-watt { border-bottom: 4px solid var(--color-watt); }
        .card-watt:hover { box-shadow: 0 10px 40px rgba(8, 217, 214, 0.2); }
        .card-watt .icon-bg { background: var(--color-watt); }
        .card-watt .value { color: var(--color-watt); text-shadow: 0 0 15px rgba(8, 217, 214, 0.4); }

        /* 4. Energy (Kuning) */
        .card-kwh { border-bottom: 4px solid var(--color-kwh); }
        .card-kwh:hover { box-shadow: 0 10px 40px rgba(249, 237, 105, 0.2); }
        .card-kwh .icon-bg { background: var(--color-kwh); }
        .card-kwh .value { color: var(--color-kwh); text-shadow: 0 0 15px rgba(249, 237, 105, 0.4); }

        /* Label */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-label {
            font-size: 1.1rem;
            color: #ddd;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Lingkaran Dekorasi Kecil */
        .icon-bg {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        /* Nilai Digital */
        .value {
            font-family: 'Digital-7 Mono', monospace;
            font-size: 4.5rem;
            text-align: right;
            line-height: 1;
            margin-top: 10px;
        }

        .unit {
            font-size: 1.2rem;
            font-family: 'Rajdhani', sans-serif;
            color: rgba(255,255,255,0.7);
            text-shadow: none;
            margin-left: 5px;
            font-weight: normal;
        }

        footer {
            margin-top: 50px;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.4);
            letter-spacing: 2px;
        }
    </style>
</head>
<body>

    <h1>Energy Dashboard</h1>
    <div id="status" class="status-disconnected">Status: CONNECTING...</div>

    <div class="dashboard">
        <div class="card card-volt">
            <div class="card-header">
                <div class="card-label">Voltage</div>
                <div class="icon-bg"></div>
            </div>
            <div class="value">
                <span id="val-volt">000</span><span class="unit">V</span>
            </div>
        </div>

        <div class="card card-amp">
            <div class="card-header">
                <div class="card-label">Current</div>
                <div class="icon-bg"></div>
            </div>
            <div class="value">
                <span id="val-amp">0.00</span><span class="unit">A</span>
            </div>
        </div>

        <div class="card card-watt">
            <div class="card-header">
                <div class="card-label">Active Power</div>
                <div class="icon-bg"></div>
            </div>
            <div class="value">
                <span id="val-watt">0000</span><span class="unit">W</span>
            </div>
        </div>

        <div class="card card-kwh">
            <div class="card-header">
                <div class="card-label">Total Energy</div>
                <div class="icon-bg"></div>
            </div>
            <div class="value">
                <span id="val-kwh">000.0</span><span class="unit">kWh</span>
            </div>
        </div>
    </div>

    <footer>
        PZEM-017 | MQTT WEBSOCKET | REALTIME
    </footer>

    <script>
        // --- KONFIGURASI MQTT (TIDAK DIUBAH) ---
        const mqtt_broker = "broker.emqx.io";
        const mqtt_port = 8084; 
        const mqtt_topic = "kampus/pzem017/data"; 
        const client_id = "web_dashboard_" + Math.random().toString(16).substr(2, 8);

        const client = new Paho.MQTT.Client(mqtt_broker, mqtt_port, client_id);

        client.onConnectionLost = function (responseObject) {
            console.log("Connection Lost: " + responseObject.errorMessage);
            document.getElementById("status").innerHTML = "Status: DISCONNECTED";
            document.getElementById("status").className = "status-disconnected";
        };

        client.onMessageArrived = function (message) {
            console.log("Data diterima: " + message.payloadString);
            
            try {
                const data = JSON.parse(message.payloadString);

                // Update tampilan HTML
                document.getElementById("val-volt").innerText = parseFloat(data.tegangan).toFixed(0); 
                document.getElementById("val-amp").innerText = parseFloat(data.arus).toFixed(2);
                document.getElementById("val-watt").innerText = parseFloat(data.daya).toFixed(1);
                document.getElementById("val-kwh").innerText = parseFloat(data.energi).toFixed(3);

                // Efek visual sederhana saat update (opsional untuk versi baru)
                // Kita biarkan css hover effects yang menangani estetika

            } catch (e) {
                console.error("Error parsing JSON: ", e);
            }
        };

        const options = {
            useSSL: true, 
            onSuccess: function () {
                console.log("MQTT Connected!");
                document.getElementById("status").innerHTML = "Status: ONLINE & RECEIVING";
                document.getElementById("status").className = "status-connected";
                client.subscribe(mqtt_topic);
            },
            onFailure: function (message) {
                console.log("Connection Failed: " + message.errorMessage);
                document.getElementById("status").innerHTML = "Status: CONNECTION FAILED";
                document.getElementById("status").className = "status-disconnected";
            }
        };

        console.log("Connecting to MQTT Broker...");
        client.connect(options);

    </script>
</body>
</html>
